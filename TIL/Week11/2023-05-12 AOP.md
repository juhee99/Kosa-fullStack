<img src="https://noticon-static.tammolo.com/dgggcrkxq/image/upload/v1566778017/noticon/ytjm1rralodyhvuggrpu.png" height="15%" width="15%"> <br/>

# 2023-05-12 / AOP

π—“οΈ λ‚ μ§β€β€β€β€β€β€β€β€β€β€β€2023/05/12

βοΈ λ‚ μ”¨β€β€β€β€β€β€β€β€β€β€β€β€οΈ λ€μ²΄λ΅ νλ¦Ό (18Β°C)

## 01. AspectJ μ„¤μΉ

- ApectJκ°€ μ κ³µν•λ” μ–΄λ…Έν…μ΄μ…μ΄λ‚ κ΄€λ ¨ μΈν„°νμ΄μ¤λ§ μ‚¬μ©ν•κ³  μ‹¤μ λ΅ AspectJκ°€ μ κ³µν•λ” μ»΄νμΌ, λ΅λ“νƒ€μ„ μ„λ²„ λ“±μ€ μ‚¬μ©ν•μ§€ μ•λ”λ‹¤.

<img src="https://github.com/juhee99/Msa-Dkteckin-fullstack/assets/55836020/652c57a1-9d9f-48d6-b3f5-1832c45ce45e" width="80%" />

fileβ†’Project structure β†’ librariesβ†’aspectjweaver:1.9.9

## 02. κ΄€μ  μ§€ν–¥ ν”„λ΅κ·Έλλ°(AOP)

π’΅ μ–΄λ–¤ κΈ°λ¥μ„ κµ¬ν„ν•  λ• κ°€κ°μ ν•λ‚μ κ΄€μ μΌλ΅ λ³΄λ©° κ·Έ κ΄€μ μ„ κΈ°μ¤€μΌλ΅ λ¬¶μ–΄μ„ κ°λ°ν•λ” λ°©μ‹ β‡’ `ν•µμ‹¬ κΈ°λ¥κ³Ό λ¶€κ°€ κΈ°λ¥μ„ λ‚λ `μ„ κ°λ°

- μ—¬λ¬ ν•µμ‹¬ κΈ°λ¥μ— λ°λ³µλλ” λ¶€κ°€ κΈ°λ¥μ„ ν•λ‚μ κ³µν†µ λ΅μ§μΌλ΅ μ²λ¦¬ν•λ„λ΅ λ¨λ“ν™” ν•μ—¬ μ‚½μ…ν•λ” λ°©μ‹ AOP
- aspect : μ–΄λ μ‹μ μ— μ–΄λ–¤ κΈ°λ¥μ΄ ν•„μ”ν•λ‹¤.
- advice : λ¶€κ°€ κΈ°λ¥
- advisor : μ–΄λ μ‹μ μ—μ„ μ–΄λ–¤ λ¶€κ°€ κΈ°λ¥

### 2.1AOP κµ¬ν„ λ°©λ²•

1. μ»΄νμΌ κ³Όμ •μ— μ‚½μ… (Springμ€ μ§€μ› μ•ν•¨, μ»΄νμΌ μ‹μ )
2. λ°”μ΄νΈμ½”λ“λ¥Ό λ©”λ¨λ¦¬μ— λ΅λ“ν•λ” κ³Όμ •μ—μ„ μ‚½μ…(LTW) (λμΌλ΅ λ³΄κΈ° μ–΄λ ¤μ›€, ν΄λμ¤ λ΅λ”© μ‹μ )
3. **ν”„λ΅μ‹ ν¨ν„΄μ„ μ΄μ©** (μΌλ°μ μΈ λ°©λ²•, μ¤ν”„λ§ μ§€μ›, λ°νƒ€μ„ μ‹μ )


## 03. ν”„λ΅μ‹ ν¨ν„΄(Proxy Pattern)

π’΅  λ€λ¦¬μ, λ€λ¦¬μΈμ μλ―Έλ΅ ν”„λ΅μ‹μ—κ² μ–΄λ–¤ μΌμ„ λ€μ‹  μ‹ν‚¤λ” κ²ƒμ΄λ‹¤.

- μ–΄λ–¤ κ°μ²΄λ¥Ό μ‚¬μ© ν•  λ•, κ°μ²΄λ¥Ό μ§μ ‘μ μΌλ΅ μ°Έμ΅°ν•λ” κ²ƒμ΄ μ•„λ‹ ν•΄λ‹Ή κ°μ²΄λ¥Ό λ€μ‹ ν•λ” κ°μ²΄(proxy)ν†µν•΄ λ€μƒ κ°μ²΄μ— μ ‘κ·Ό ν•λ” λ°©μ‹
- λ€λ¦¬μλ” μ‹¤μ  μ„λΉ„μ¤μ™€ κ°™μ€ μ΄λ¦„μ λ©”μ„λ“λ¥Ό κµ¬ν„, μ΄λ• `μΈν„°νμ΄μ¤`λ¥Ό μ‚¬μ©
- λ€λ¦¬μλ” μ‹¤μ  μ„λΉ„μ¤μ— λ€ν• μ°Έμ΅° λ³€μλ¥Ό κ°–λ”λ‹¤
- μ‹¤μ  λ€μƒ μ½”λ“λ” κ·Έλλ΅ μ μ§€ λκ³  ν”„λ΅μ‹λ¥Ό ν†µν•΄ λ¶€κ°€ κΈ°λ¥μ΄ μ μ©
- ν”„λ΅μ‹λ” λ©”μ„λ“ μ¤λ²„λΌμ΄λ”© κ°λ…μΌλ΅ λ™μ‘ν•κΈ° λ•λ¬Έμ— λ©”μ„λ“μ—μ„λ§ μ μ© κ°€λ¥ β†’ μ¤ν”„λ§ λΉμ—μ„λ§ μ μ© κ°€λ¥
- μΈν„°νμ΄μ¤
    - service(μΈν„°νμ΄μ¤ μƒμ†)
    - proxy (μΈν„°νμ΄μ¤ μƒμ†)

<img src="https://github.com/juhee99/Msa-Dkteckin-fullstack/assets/55836020/a6bd08eb-63e9-401b-ba86-36c9b8ea8fba" width="80%" />

- beanμ€ clientκ°€ μ‚¬μ©ν•λ” κ°μ²΄
- beanμ μΈν„°νμ΄μ¤ μ λ¬΄μ— λ”°λΌ μ‚¬μ©λ°©μ‹μ΄ λ‹¬λΌμ§€λ”λ° ν„μ¬λ” CGLibλ§ μ‚¬μ©ν•λ‹¤

## 04. AOP μ©μ–΄

<img src="https://github.com/juhee99/Msa-Dkteckin-fullstack/assets/55836020/c67d0339-74e3-4554-9c36-bf2ce94268ec" width="80%"/>

| JoinPoint | adviceκ°€ μ μ©λ  μ μλ” λ¨λ“  μ„μΉλ¥Ό λ§ν•λ‹¤.                                                    ν”„λ΅μ‹ λ°©μ‹μ—μ„λ”  μ΅°μΈ ν¬μΈνΈλ” ν•­μƒ λ©”μ„λ“ μ‹¤ν–‰ μ‹μ  |
| --- | --- |
| Piontcut | μ΅°μΈ ν¬μΈνΈ μ¤‘μ—μ„ adviceκ°€ μ μ©λ  μ„μΉλ¥Ό μ„ λ³„ν•λ” κΈ°λ¥                         ν”„λ΅μ‹ λ°©μ‹μ—μ„ μ΅°μΈ ν¬μΈνΈ μ¤‘μ—μ„ μ–΄λ–¤ μ„μΉμ— μ‹¤ν–‰ μ‹ν‚¬μ§€κ°€ ν¬μΈνΈ μ»· |
| Target |  adviceμ λ€μƒμ΄ λλ” κ°μ²΄                                                                                 PointcutμΌλ΅ κ²°μ •λ¨ |
| Advice | μ‹¤μ§μ μΈ λ¶€κ°€ κΈ°λ¥ λ΅μ§μ„ μ •μν•λ” κ³³                                                                    νΉμ • μ΅°μΈ ν¬μΈνΈμ—μ„ Aspectμ— μν•΄ μ·¨ν•΄μ§€λ” μ΅°μΉ |
| Aspect | Advice + Pointcutμ„ λ¨λ“ν™” ν• κ²ƒ |
| Advisor | Advice+pointcut ν• μ |
| Weaving | PointcutμΌλ΅ κ²°μ •ν• νƒ€κ²μ JoinPoint μ— Adviceλ¥Ό μ μ©ν•λ” κ²ƒ |

## 05. μ–΄λ…Έν…μ΄μ… μ •λ¦¬

- Aspect μ–΄λ…Έν…μ΄μ…μ„ μ΄μ©ν•μ—¬ Aspect ν΄λμ¤μ— Adviceμ™€ Pointcutμ„ μ„¤μ •
- aop:aspectj-autoproxy/λ¥Ό μ¶”κ°€ β‡’xml νμΌμ—
- Aspect Classλ¥Ό λΉμΌλ΅ λ“±λ΅(@Component)

### 5.1 μ–΄λ…Έν…μ΄μ… μΆ…λ¥

- @Aspect : Aspect ν΄λμ¤ μ„ μ–Έ
- @Before(β€pointcutβ€)
    - μ΅°μΈ ν¬μΈνΈ μ‹¤ν–‰ μ΄μ „μ— μ‹¤ν–‰, target λ©”μ„λ“ μν–‰ μ „μ— μ‹¤ν–‰
- @AfterReturning(β€pointcutβ€)
    - μ΅°μΈ ν¬μΈνΈκ°€ μ •μƒ μ™„λ£ ν›„ μ‹¤ν–‰
- @AfterThrowing(pointcut="", throwing="")
    - λ©”μ„λ“κ°€ μμ™Έλ¥Ό λμ§€λ” κ²½μ°, μμ™Έ μ΅°μ‘ λ¶κ°€λ¥
- @After("pointcut")
    - μ΅°μΈ ν¬μΈνΈμ μμ™Έ λ™μ‘κ³Ό λ¬΄μΆν•κ² μ‹¤ν–‰
    - *λ§¤κ°λ³€μλ΅ JoinPointμ€ μ΅°κ±΄μ— λ§μ΅±ν•λ” pointcutμ μ •λ³΄λ¥Ό λ¶λ¬ μ¬ μ μλ‹¤*
- @Around("point") : μ „λ°μ 
    - λ‹¤λ¥Έ 4κ°€μ§€ μ–΄λ…Έν…μ΄μ…μ„ λ¨λ‘ ν¬ν•¨ν•λ” μ–΄λ…Έν…μ΄μ… β‡’ μ—¬λ¬κ° μ²λ¦¬ν•  μ μμ
    - Around λ©”μ„λ“ μΈμλ΅ ProceedingJoinPointλ¥Ό κ°€μ§ μ μλ‹¤.
    - *@Around*("within(ν¨ν‚¤μ§€.ν΄λμ¤λ…)") β†’ ν΄λμ¤ λ‚΄μ— μλ” λ¨λ“  λ©”μ†λ“
    - Adviceλ΅ μμ™Έ μ²λ¦¬λ¥Ό λ€μ‹ ν• λ ¤λ©΄  Aroundλ΅ μμ™Έ μ²λ¦¬ ν•΄μ•Όν•λ‹¤,
- @Pointcut(β€execution(μ΅°κ±΄)β€)

### 5.2 λ™μ‘ μμ„

`Around -> Before -> AfterThrowing -> AfterReturning -> After -> Around`

### 5.3 ν¬μΈνΈμ»· μ •μ

π’΅ Pointcutμ€ Adviceκ°€ μ μ©λ  μ„μΉλ¥Ό μ„ λ³„ν•λ” κΈ°λ¥

- execution([μ ‘κ·Όμ μ–΄μ] λ°ν™νƒ€μ… [μ„ μ–Ένƒ€μ…]λ©”μ„λ“μ΄λ¦„(νλΌλ―Έν„°) [μμ™Έ])
    - μ‹¤μ§μ μΌλ΅ κ°€μ¥ λ§μ΄ μ‚¬μ©
- within
    - withinμ€ ν΄λμ¤ νƒ€μ…μ„ μ§€μ •ν•λ” κ²ƒμΌλ΅ κ·Έ μ•μ— λ¨λ“  λ©”μ„λ“κ°€ λ§¤μΉ­
    - execution μ—μ„ νƒ€μ…λ¶€λ¶„λ§ μ‚¬μ©ν•λ” κ²ƒκ³Ό λ™μΌ
- bean
    - μ¤ν”„λ§ λΉμ μ΄λ¦„μΌλ΅ AOP μ μ© μ—¬λ¶€λ¥Ό μ§€μ •
    - μ¤ν”„λ§μ—μ„λ§ μ‚¬μ© κ°€λ¥

> *joinPoint.getSignature().getName() -> joinPointμ— ν•΄λ‹Ήν•λ” λ©”μ†λ“ νΈμ¶ κ°€λ¥*
> 
> 
>

## κΈ°νƒ€

- StopWatch sw = new StopWatch(); β†’ μ¤νƒ‘μ›μΉλ¥Ό μ‹¤ν–‰ν•λ” κ°μ²΄
- sw.start() ~ sw.stop(); β‡’ μ΄ μ‚¬μ΄μ— μ‹¤ν–‰λλ” λ΅μ§μ κ±Έλ¦¬λ” μ‹κ°„

## 06. Exercise /AOP

<details>
<summary> π“AOP μ‹¤μµ νΌμ³λ³΄κΈ°</summary>
<div markdown="1">


[5μ›”12μΌ_1.pdf](https://github.com/juhee99/Msa-Dkteckin-fullstack/files/11475119/5.12._1.pdf)

1οΈβƒ£ **[ μ‹¤μµ 1 ]**

```java
@Component
@Aspect
public class AOPLab1 {
    @Pointcut("execution(public * com.example.springedu.controller.HelloController.*(..))")
    public void hello(){}

    @Before("hello()")
    public void before(){
        System.out.println("[AOP]hello μν–‰μ „");
    }

    @After("hello()")
    public void after(){
        System.out.println("[AOP]hello μν–‰ ν›„");
    }
}
```

2οΈβƒ£ **[ μ‹¤μµ 2]**

```java
@Component
@Aspect
public class AOPLab2 {

    @Before("execution(public * com.example.springedu.controller.MultiController.select*())")
    public void before(){
        System.out.println("[AOP]select_proc μν–‰μ „");
    }

    @After("execution(public * com.example.springedu.controller.MultiController.select*())")
    public void after(){
        System.out.println("[AOP]select_proc μν–‰ν›„");
    }
}
```

3οΈβƒ£ **[μ‹¤μµ 3]**

```java
@Slf4j
@Component
@Aspect
public class AOPLab3 {

    @Around("within(com.example.springedu.controller.EmpController)")
    public Object around(ProceedingJoinPoint jp)  {
        Object result = null;
        StopWatch sw = new StopWatch();
        sw.start();
        try {
            result = jp.proceed();
        }catch(Throwable e) {
            System.out.println(":::μ¤λ¥ λ°μƒ λ©”μ‹μ§€ : " + e.getMessage());
        }
        sw.stop();
        log.info(jp.getTarget().getClass().getName()+"  [LOG]-μν–‰μ‹κ°„"+sw.getTotalTimeMillis()+"λ°€λ¦¬μ΄");
        return result;
    }
}
```
</div>
</details>
